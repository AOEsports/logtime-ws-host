<head>
	<title>Overwatch Stats</title>
	<link
		href="//cdn.muicss.com/mui-0.10.3/css/mui.min.css"
		rel="stylesheet"
		type="text/css"
	/>
	<link href="//cdn.muicss.com/mui-0.10.3/extra/mui-rem.min.css" rel="stylesheet" type="text/css" />
	<link href="//cdn.muicss.com/mui-0.10.3/extra/mui-colors.min.css" rel="stylesheet" type="text/css" />

	<script>
		let WebSockerServer = null;

		function submitForm(e) {
			// submit form to the /submit endpoint
			console.log(`submittin`);
			e.preventDefault();
			fetch("/submit", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({
					workshop: document.getElementById("workshop").value,
					websocket: document.getElementById("websocket").value,
				}),
			})
				.then((res) => res.text())
				.then((text) => {
					console.log(text);
					if (text !== "true") {
						alert(text);
					} else {
						// close exisitng
						if (WebSockerServer) {
							WebSockerServer.close();
						}
						// create websocket connection

						WebSockerServer = new WebSocket(
							document.getElementById("websocket").value
						);
						WebSockerServer.onopen = function (event) {
							console.log("Connected to websocket server");
							// send a message to the server
							WebSockerServer.send(
								JSON.stringify({
									type: "init",
									id: "data",
								})
							);
						};
						WebSockerServer.onmessage = function (event) {
							console.log(event.data);
							const parsedData = JSON.parse(event.data);
							if (parsedData.type == "data") {
								const data = parsedData.data;
								if (!data.matchInformation) {
									// reset all  dataTarget elements to "Waiting"
									const dataTargets =
										document.getElementsByClassName(
											"dataTarget"
										);
									for (
										let i = 0;
										i < dataTargets.length;
										i++
									) {
										dataTargets[i].innerHTML = "Waiting";
									}
									return;
								}

								document.getElementById("load.Map").innerHTML =
									data.matchInformation.map;
								document.getElementById(
									"load.MapMode"
								).innerHTML = data.matchInformation.mode;
								document.getElementById(
									"load.Team1"
								).innerHTML = data.matchInformation.team_1;
								document.getElementById(
									"load.Team2"
								).innerHTML = data.matchInformation.team_2;
								document.getElementById(
									"load.RoundStatus"
								).innerHTML = data.round_status;

								const serverLoad = data.server_load;
								document.getElementById(
									"load.Current"
								).innerHTML = serverLoad.current;
								document.getElementById("load.Peak").innerHTML =
									serverLoad.peak;
								document.getElementById(
									"load.Average"
								).innerHTML = serverLoad.average;

								const parserLoad = parsedData.parser_load;
								console.log(parserLoad);
								document.getElementById(
									"parser.ConnectionCount"
								).innerHTML = parserLoad.totalConnections;

								document.getElementById(
									"parser.Lines"
								).innerHTML = parserLoad.lineCount;

								document.getElementById(
									"parser.ParseTime"
								).innerHTML = `${parserLoad.parseTime}ms`;

								document.getElementById(
									"parser.CurrentFile"
								).innerHTML = parserLoad.fileName
									.replace("Log-", "")
									.replace(".txt", "");
							}
						};
					}
				});
		}
	</script>
</head>
<body>
	<div class="mui-container">
		<div class="mui-panel">
			<form
				style="
					display: flex;
					flex-direction: column;
					gap: 4px;
					padding: 2px;
				"
			>
				<div class="mui-textfield">
					<input
						id="workshop"
						name="workshop"
						type="text"
						placeholder="C:\Documents\Overwatch\Workshop"
						value="E:\Documents\Overwatch\Workshop"
						required
					/>
					<label for="workshop"
						>Direct Path to your \Documents\Overwatch\Workshop
						folder</label
					>
				</div>

				<div class="mui-textfield">
					<input
						id="websocket"
						name="websocket"
						type="text"
						placeholder="ws://localhost:3000"
						value="ws://172.22.174.166:3000"
						required
					/>
					<label for="websocket">WebSocket Server Target IP</label>
				</div>
				<button
					type="submit"
					class="mui-btn mui-btn--primary mui-btn--raised"
					onclick="submitForm(event)"
				>
					Update
				</button>
			</form>
		</div>
		<div class="mui-panel">
			<div class="mui--text-display2">Overwatch Match Information</div>
			<div class="mui--text-body1 mui-row">
				<div class="mui--text-display1 mui-col-md-4">
					Map
					<div class="mui--text-headline dataTarget" id="load.Map">
						Waiting
					</div>
				</div>

				<div class="mui--text-display1 mui-col-md-4">
					Team 1
					<div class="mui--text-headline dataTarget" id="load.Team1">
						Waiting
					</div>
				</div>
				<div class="mui--text-display1 mui-col-md-4">
					Team 2
					<div class="mui--text-headline dataTarget" id="load.Team2">
						Waiting
					</div>
				</div>
				<div class="mui--text-display1 mui-col-md-4">
					Mode
					<div class="mui--text-headline dataTarget" id="load.MapMode">
						Waiting
					</div>
				</div>
				

				<div class="mui--text-display1 mui-col-md-4">
					Round Status
					<div
						class="mui--text-headline dataTarget"
						id="load.RoundStatus"
					>
						Waiting
					</div>
				</div>

				<div class="mui--text-display1 mui-col-md-4">
					Match ID
					<div
						class="mui--text-headline dataTarget"
						id="parser.CurrentFile"
					>
						Waiting
					</div>
				</div>
			</div>
		</div>
		<div class="mui-panel">
			<div class="mui--text-display2">Overwatch Server Load</div>
			<div class="mui--text-body1 mui-row">
				<div class="mui--text-display1 mui-col-md-4">
					Current
					<div
						class="mui--text-headline dataTarget"
						id="load.Current"
					>
						Waiting
					</div>
				</div>

				<div class="mui--text-display1 mui-col-md-4">
					Peak
					<div class="mui--text-headline dataTarget" id="load.Peak">
						Waiting
					</div>
				</div>
				<div class="mui--text-display1 mui-col-md-4">
					Average
					<div
						class="mui--text-headline dataTarget"
						id="load.Average"
					>
						Waiting
					</div>
				</div>
			</div>
		</div>
		<div class="mui-panel">
			<div class="mui--text-display2">Parser Server Load</div>
			<div class="mui--text-body1 mui-row">
				<div class="mui--text-display1 mui-col-md-4">
					Connections
					<div
						class="mui--text-headline dataTarget"
						id="parser.ConnectionCount"
					>
						Waiting
					</div>
				</div>
				<div class="mui--text-display1 mui-col-md-4">
					Lines
					<div
						class="mui--text-headline dataTarget"
						id="parser.Lines"
					>
						Waiting
					</div>
				</div>
				<div class="mui--text-display1 mui-col-md-4">
					Last Time to Parse
					<div
						class="mui--text-headline dataTarget"
						id="parser.ParseTime"
					>
						Waiting
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
